entities:
- name: service
  namespace: laplacian.arch.api.service
  properties:
  - name: name
    type: string

  - name: identifier
    type: string
    domain_type_name: identifier
    optional: true
    default_value: |
      name.lowerUnderscorize()

  - name: version
    type: string

  - name: api_version
    type: string
    optional: true
    default_value: |
      "v1"

  - name: endpoint
    type: string
    optional: true
    default_value: |
      "${protocol}://${host}:${port}${path}/${apiVersion}"

  - name: host
    type: string
    optional: true
    default_value: |
      "identifier.lowerHyphenize()"

  - name: port
    type: number
    optional: true
    default_value: |
      8080

  - name: protocol
    type: string
    domain:
      choices:
      - value: http
      - value: https
    optional: true
    default_value: |
      "http"

  - name: path
    type: string
    optional: true
    default_value: |
      "/${identifier.lowerHyphenize()}"

  - name: namespace
    type: string
    domain_type_name: namespace
    optional: true
    default_value: |
      "${_context.get("project.namespace")}.service.$identifier"

  - name: description
    type: string
    optional: true
    default_value: |
      name

  - name: datasource_name
    type: string

  relationships:
  - name: resource_entries
    cardinality: '*'
    reference_entity_name: resource_entry
    aggregate: true

  - name: resources
    cardinality: '*'
    reference_entity_name: rest_resource
    snippet: |
      resourceEntries.map{ it.resource }

  - name: datasource
    cardinality: '1'
    reference_entity_name: datasource
    mappings:
    - from: datasource_name
      to: name

  - name: entities_used_in_rest_service
    cardinality: '*'
    reference_entity_name: entity
    snippet: |
      resources
      .flatMap{ it.relatingEntities }
      .distinctBy{ it.fqn }

  - name: relating_entities
    cardinality: '*'
    reference_entity_name: entity
    snippet: |
      entitiesUsedInRestService + entitiesUsedInGraphql

  - name: relating_top_level_entities
    cardinality: '*'
    reference_entity_name: entity
    snippet: |
      relatingEntities
      .filter{ it.topLevel }
      .distinct()

  - name: graphql_queries
    cardinality: '*'
    reference_entity_name: graphql_query
    aggregate: true

  - name: graphql_type_entries
    cardinality: '*'
    reference_entity_name: graphql_type_entry
    aggregate: true

  - name: graphql_types
    cardinality: '*'
    reference_entity_name: graphql_type
    snippet: |
      graphqlTypeEntries.map{ it.graphqlType }.distinct()

  - name: entities_used_in_graphql
    cardinality: '*'
    reference_entity_name: entity
    snippet: |
      graphqlTypes.map{ it.entity }.filterNotNull()

  - name: entities_used_in_graphql
    cardinality: '*'
    reference_entity_name: entity
    snippet: |
      graphqlTypes.map{ it.entity }.filterNotNull()

  - name: top_level_entities_used_in_graphql
    cardinality: '*'
    reference_entity_name: entity
    snippet: |
      entitiesUsedInGraphql.filter{ it.topLevel }

- name: graphql_type_entry
  namespace: laplacian.arch.api.service

  properties:
  - name: type_name
    type: string

  relationships:
  - name: service
    reference_entity_name: service
    cardinality: '1'
    reverse_of: graphql_type_entries

  - name: graphql_type
    reference_entity_name: graphql_type
    cardinality: '1'
    mappings:
    - from: type_name
      to: name
