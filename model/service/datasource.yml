entities:
  - name: datasource
    namespace: laplacian_arch.service_api_arch

    properties:
      - name: name
        type: string

      - name: type
        type: string
        domain:
          choices:
            - value: postgres

      - name: identifier
        type: string
        optional: true
        domain_type_name: identifier
        default_value: |
          name.lowerUnderscorize()

      - name: description
        type: string
        optional: true
        default_value: |
          name

      - name: hostname
        type: string
        optional: true
        default_value: |
          "${identifier.lowerHyphenize()}"

      - name: port
        type: number
        optional: true
        default_value: |
          5432

      - name: jdbc_url
        type: string
        optional: true
        default_value: |
          if (type == "postgres") {
              "jdbc:postgresql://$hostname:$port/$dbname"
          }
          else {
              throw IllegalStateException(
                  "Unknown database type: $type"
              )
          }

      - name: dbname
        type: string
        optional: true
        default_value: |
          user

      - name: user
        type: string

      - name: password
        type: string
        optional: true

      - name: container_name
        type: string
        optional: true
        default_value: |
          identifier

      - name: container_image
        type: string
        optional: true
        default_value: |
          when(type) {
            "postgresql" -> "postgres"
            else -> "postgres"
          }

    relationships:
      - name: entity_references
        cardinality: '*'
        reference_entity_name: entity_reference
        aggregate: true

      - name: entities
        cardinality: '*'
        reference_entity_name: entity
        snippet: |
          entityReferences.map{ it.entity }

      - name: top_level_entities
        cardinality: '*'
        reference_entity_name: entity
        snippet: |
          entities.filter{ it.topLevel }

  - name: entity_reference
    properties:
      - name: entity_name
        type: string

    relationships:
      - name: datasource
        cardinality: '1'
        reference_entity_name: datasource
        inherited: true

      - name: entity
        cardinality: '1'
        reference_entity_name: entity
        mappings:
          - from: entity_name
            to: name